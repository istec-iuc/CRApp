import os
import lzma
import requests

def download_and_extract_latest_cve_files(save_dir="cveOffline"):
    os.makedirs(save_dir, exist_ok=True)

    # Step 1: Get latest release info
    api_url = "https://api.github.com/repos/fkie-cad/nvd-json-data-feeds/releases/latest"
    resp = requests.get(api_url, timeout=10)
    resp.raise_for_status()
    release = resp.json()

    assets = release.get("assets", [])
    #print("ASSETS")
    #print(assets)
    required_files = ["CVE-recent.json.xz", "CVE-modified.json.xz"]

    for asset in assets:
        name = asset['name']
        download_url = asset['browser_download_url']

        if name in required_files:
            xz_path = os.path.join(save_dir, name)
            json_path = os.path.splitext(xz_path)[0]

            print(f"Downloading {name} from {download_url}")
            r = requests.get(download_url, stream=True)
            r.raise_for_status()

            with open(xz_path, 'wb') as f:
                for chunk in r.iter_content(chunk_size=8192):
                    f.write(chunk)

            with lzma.open(xz_path) as f_in, open(json_path, 'wb') as f_out:
                f_out.write(f_in.read())

            print(f"âœ“ Downloaded and extracted: {name}")
