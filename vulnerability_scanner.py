# vulnerability_scanner.py
import requests

def scan_vulnerabilities(components, api_key=None):
    """
    Her bileşen için NVD REST API'den CVE'leri çeker.
    components: [{'component': name, 'version': version}, ...]
    api_key: (isteğe bağlı) NVD API anahtarı
    """
    headers = {}
    if api_key:
        headers['Api-Key'] = api_key

    results = []
    for comp in components:
        name = comp['component']
        # Basit sorgu: component adı
        params = {'keywordSearch': name, 'resultsPerPage': 10}
        resp = requests.get(
            'https://services.nvd.nist.gov/rest/json/cves/2.0',
            headers=headers, params=params, timeout=10
        )
        if resp.status_code != 200:
            continue
        data = resp.json().get('vulnerabilities', [])
        for item in data:
            cve_id = item['cve']['id']
            desc = item['cve']['descriptions'][0]['value']
            # CVSS puanını bul
            metrics = item['cve'].get('metrics', {})
            cvss = None
            if 'cvssMetricV31' in metrics:
                cvss = metrics['cvssMetricV31'][0]['cvssData']['baseScore']
            elif 'cvssMetricV2' in metrics:
                cvss = metrics['cvssMetricV2'][0]['cvssData']['baseScore']
            results.append({
                'component': name,
                'cve': cve_id,
                'cvss': cvss or 0.0,
                'desc': desc
            })
    return results